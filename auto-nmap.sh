#!/bin/bash
red='\033[1;91m'
rst='\033[0m'

echo ""
help="Usage: auto-nmap [target] [top-ports]"
[[ "$1" = "-h" ]] && echo $help && exit
[[ -z "$1" ]] && echo "No target provided."
[[ -z "$2" ]] && echo "No number of top port to scan given."
[[ -z "$1" ]] || [[ -z "$2" ]] && echo $help && exit

stdout=$(sudo nmap -T4 --top-ports $2 -oN nmap-scan-$(date +"%Y-%m-%d_%H:%M:%S").txt $1 | tee /dev/tty | grep open)

while IFS= read -r line; do
    ports+="$(echo "$line" | cut -d "/" -f 1),"
done <<<"$stdout"

echo -e "\nOpen ports: $red$(echo "$ports" | tr ',' ' ')$rst"
read -p "Deep scan these ports? (y/n): " answer
echo ""
# Convert the answer to lowercase for case-insensitive comparison
answer=${answer,,}

if [[ $answer == "y" ]]; then
    sudo nmap -A -T4 -p $ports -oN nmap-scan-$(date +"%Y-%m-%d_%H:%M:%S").txt $1
    echo -e "\nOutput saved in ${red}nmap-scan-$(date +"%Y-%m-%d_%H:%M:%S").txt$end"
else
    [[ $answer == "n" ]]
    exit
fi
